{% extends "base.html" %}
{% load static %}

{% block content %}
<h2 style="margin-bottom: 1rem; color: green;">
  <i class="fas fa-plus-circle" style="color: green; margin-right: 0.5rem;"></i>
  {% if editing_draft %}
    Edit Communication Draft
  {% else %}
    Create Communication
  {% endif %}
</h2>

<style>
  #form-fields-container {
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 1rem;
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    justify-content: flex-start;
    align-items: flex-start;
    overflow-x: visible;
    white-space: normal;
    background-color: rgb(242, 243, 245);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  }

  #form-fields-container legend {
    font-weight: 600;
    font-size: 1.1rem;
    padding: 0 0.5rem;
    flex-basis: 100%;
    margin-bottom: 1rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    min-width: 180px;
    flex-grow: 1;
    margin-top: -2rem;
  }

  .form-label {
    margin-bottom: 0.3rem;
    font-weight: 500;
  }
</style>

<!-- Target Group Filter Form -->
<form id="target-group-form" method="get" style="margin-bottom: 1rem;">
  <fieldset id="form-fields-container">
    <legend>Select Target Group</legend>

    {% if user_role != "student" and user_role != "parent" %}
      <div id="branch-field" class="form-group">
        <label for="id_branch" class="form-label">Branch:</label>
        {{ target_group_form.branch }}
        {% if target_group_form.branch.errors %}
          <div class="text-danger">{{ target_group_form.branch.errors }}</div>
        {% endif %}
      </div>
    {% else %}
      <input type="hidden" id="id_branch" name="branch" value="{{ user_branch_id }}" />
    {% endif %}

    <div id="role-field" class="form-group" style="display: none;">
      <label for="{{ target_group_form.role.id_for_label }}" class="form-label">{{ target_group_form.role.label }}:</label>
      {{ target_group_form.role }}
      {% if target_group_form.role.errors %}
        <div class="text-danger">{{ target_group_form.role.errors }}</div>
      {% endif %}
    </div>

    <div id="staff-type-field" class="form-group" style="display: none;">
      <label for="{{ target_group_form.staff_type.id_for_label }}" class="form-label">{{ target_group_form.staff_type.label }}:</label>
      {{ target_group_form.staff_type }}
      {% if target_group_form.staff_type.errors %}
        <div class="text-danger">{{ target_group_form.staff_type.errors }}</div>
      {% endif %}
    </div>

    <div id="teaching-positions-field" class="form-group" style="display: none;">
      <label class="form-label">Teaching Positions:</label>
      <div id="id_teaching_positions">
        {% for position in target_group_form.fields.teaching_positions.queryset %}
          <div class="form-check">
            <input
              type="checkbox"
              name="teaching_positions"
              value="{{ position.id }}"
              class="form-check-input"
              data-is-class-teacher="{% if position.is_class_teacher %}1{% else %}0{% endif %}"
              {% if position in target_group_form.initial.teaching_positions %}checked{% endif %}
              id="teaching_pos_{{ position.id }}"
            >
            <label class="form-check-label" for="teaching_pos_{{ position.id }}">
              {{ position.name }}
            </label>
          </div>
        {% endfor %}
      </div>
      {% if target_group_form.teaching_positions.errors %}
        <div class="text-danger">{{ target_group_form.teaching_positions.errors }}</div>
      {% endif %}
    </div>

    <div id="non-teaching-positions-field" class="form-group" style="display: none;">
      <label for="{{ target_group_form.non_teaching_positions.id_for_label }}" class="form-label">{{ target_group_form.non_teaching_positions.label }}:</label>
      {{ target_group_form.non_teaching_positions }}
      {% if target_group_form.non_teaching_positions.errors %}
        <div class="text-danger">{{ target_group_form.non_teaching_positions.errors }}</div>
      {% endif %}
    </div>

    <div id="student-class-field" class="form-group" style="display: none;">
      <label for="{{ target_group_form.student_class.id_for_label }}" class="form-label">{{ target_group_form.student_class.label }}:</label>
      {{ target_group_form.student_class }}
      {% if target_group_form.student_class.errors %}
        <div class="text-danger">{{ target_group_form.student_class.errors }}</div>
      {% endif %}
    </div>

    <div id="class-arm-field" class="form-group" style="display: none;">
      <label for="{{ target_group_form.class_arm.id_for_label }}" class="form-label">{{ target_group_form.class_arm.label }}:</label>
      {{ target_group_form.class_arm }}
      {% if target_group_form.class_arm.errors %}
        <div class="text-danger">{{ target_group_form.class_arm.errors }}</div>
      {% endif %}
    </div>

  </fieldset>
</form>

<!-- Communication Form -->
<form
  id="communication-form"
  method="post"
  action="{% if editing_draft %}{% url 'communication_edit_draft' communication.id %}{% else %}{% url 'communication_create' %}{% endif %}"
  enctype="multipart/form-data"
  style="max-width: 100%"
  data-user-role="{{ request.user.role }}"
>
  {% csrf_token %}

  {% if form_error %}
    <div class="alert alert-warning" role="alert">
      There was an error with your previous submission. Please correct the highlighted fields.
    </div>
  {% endif %}

  {% if attachment_formset.non_form_errors %}
    <div class="alert alert-danger" style="margin-bottom: 1rem;">
      {{ attachment_formset.non_form_errors }}
    </div>
  {% endif %}

  {% if communication_form.non_field_errors %}
    <div style="color: red; background-color: white; border: 1px solid red; padding: 0.75rem; margin-bottom: 1rem;">
      {% for error in communication_form.non_field_errors %}
        <div>{{ error }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Recipients Table -->
  <h3 style="margin-bottom: 1rem">Filtered Recipients</h3>
  <table
    id="recipients-table"
    class="table table-striped"
    style="width: 100%; border-collapse: collapse; margin-bottom: 2rem"
  >
    <thead style="background-color: #007bff; color: white">
      <tr>
        <th style="padding: 0.5rem; text-align: center">
          <input type="checkbox" id="select-all-recipients" />
        </th>
        <th style="padding: 0.5rem; text-align: center">S/N</th>
        <th style="padding: 0.5rem; text-align: center">Profile Picture</th>
        <th style="padding: 0.5rem; text-align: center">Branch</th>
        <th style="padding: 0.5rem; text-align: left">Name</th>
        <th style="padding: 0.5rem; text-align: left">Email</th>
      </tr>
    </thead>
    <tbody style="border: 1px solid #ddd">
      <tr>
        <td></td>
        <td></td>
        <td colspan="6" style="padding: 1rem; text-align: center; font-style: italic; color: #555;">
          Select filters above to view recipients.
        </td>
        <td></td>
        <td></td>
        <td></td>
      </tr>
    </tbody>
  </table>

  <!-- Main Content: Message and Attachments -->
  <div style="display: flex; gap: 2rem; align-items: flex-start; flex-wrap: wrap; background-color: rgb(242, 243, 245);">
    <!-- Message Section -->
    <fieldset style="flex: 1 1 600px; border: 1px solid #ccc; border-radius: 8px; padding: 1rem;">
      <legend style="font-weight: 600; font-size: 1.2rem; padding: 0 0.5rem">Message Details</legend>

      {% for field in communication_form %}
        {% if field.name != 'is_draft' and field.name != 'requires_response' %}
          <div class="form-group mb-3 d-flex flex-column">
            <label for="{{ field.id_for_label }}" class="form-label fw-semibold mb-1">
              {{ field.label }}:
            </label>
            {{ field }}
            {% if field.help_text %}
              <small class="form-text text-muted">{{ field.help_text }}</small>
            {% endif %}
            {% if field.errors %}
              <div class="text-danger mt-1">{{ field.errors }}</div>
            {% endif %}
          </div>
        {% endif %}
      {% endfor %}

      <!-- Toggle Switches -->
      <div class="form-switch-group p-4 mt-4 rounded-4" style="background-color:#ddd;">
        <h6 class="text-black mb-3 fw-semibold">Additional Options</h6>
        <div class="d-flex flex-column flex-md-row gap-4">
          {% for field in communication_form %}
            {% if field.name == 'is_draft' or field.name == 'requires_response' %}
              <div class="form-check form-switch text-white">
                {{ field }}
                <label class="form-check-label fw-semibold ms-2" for="{{ field.id_for_label }}">
                  {{ field.label }}
                </label>
                {% if field.help_text %}
                  <div class="form-text text-light small">{{ field.help_text }}</div>
                {% endif %}
                {% if field.errors %}
                  <div class="text-danger small">{{ field.errors }}</div>
                {% endif %}
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </fieldset>

    <!-- Attachment Section -->
    <fieldset style="flex: 1 1 200px; border: 1px solid #ccc; border-radius: 8px; padding: 1rem;">
      <legend style="font-weight: 600; font-size: 1.2rem; padding: 0 0.5rem">Attachments</legend>
      {{ attachment_formset.management_form }}

      <div id="attachments-container">
        {% for form in attachment_formset.forms %}
          <div class="attachment-form {% if forloop.counter > 1 %}extra-attachment{% endif %}" style="margin-bottom: 1rem; position: relative">
            {{ form.as_p }}
            {% if forloop.counter > 1 %}
              <button type="button" class="btn btn-sm btn-danger remove-attachment mt-1"
                style="position: absolute; top: 10px; right: 10px">
                <i class="fas fa-times"></i>
              </button>
            {% endif %}
          </div>
        {% endfor %}
      </div>

      <button type="button" id="add-attachment" class="btn btn-success" style="margin-top: 0.75rem">
        Add More Files
      </button>
    </fieldset>
  </div>

  <!-- Hidden Recipients and Filter Memory -->
  <input type="hidden" name="selected_recipients" id="selected-recipients" />
  <input type="hidden" name="saved_branch" id="hidden-branch">
  <input type="hidden" name="saved_role" id="hidden-role">
  <input type="hidden" name="saved_staff_type" id="hidden-staff-type">
  <input type="hidden" name="saved_student_class" id="hidden-student-class">
  <input type="hidden" name="saved_class_arm" id="hidden-class-arm">
  <input type="hidden" name="saved_teaching_positions" id="hidden-teaching-positions">
  <input type="hidden" name="saved_non_teaching_positions" id="hidden-non-teaching-positions">

  <!-- Action Buttons -->
  <button type="submit" class="btn btn-primary" name="action" value="draft"
    id="save-draft" style="margin-top: 2rem; padding: 0.75rem 2rem; font-size: 1rem">
    Save as Draft
  </button>
  <button type="submit" class="btn btn-success" name="action" value="send"
    style="margin-top: 2rem; padding: 0.75rem 2rem; font-size: 1rem">
    Send Message
  </button>
</form>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    $(document).ready(function () {
    // Cached jQuery selectors
    const $form = $("#target-group-form");
    const $recipientsTableBody = $("#recipients-table tbody");
    const $selectAll = $("#select-all-recipients");
    const $communicationForm = $("#communication-form");
    const userRole = $communicationForm.data("user-role");

    const fields = {
        branch: $("#id_branch"),
        role: $("#id_role"),
        staffType: $("#id_staff_type"),
        teaching: $("#id_teaching_positions"),
        nonTeaching: $("#id_non_teaching_positions"),
        studentClass: $("#id_student_class"),
        classArm: $("#id_class_arm"),
    };

    let selectedRecipients = new Set();

    // Initialize DataTable or get existing instance
    let recipientsTable = $.fn.DataTable.isDataTable("#recipients-table") ?
        $("#recipients-table").DataTable() :
        $("#recipients-table").DataTable({
        columnDefs: [{ targets: 0, orderable: false, searchable: false }],
        order: [[1, "asc"]],
        });

    // Utility: Check if filters are all empty according to user role rules
    function areFiltersEmpty() {
        return Object.entries(fields).every(([key, field]) => {
        if ((userRole === "student" || userRole === "parent") && key !== "role") return true;
        if ((userRole !== "student" && userRole !== "parent") && key === "role") return true;

        if (field.is(":checkbox")) {
            return !field.prop("checked");
        } else {
            const val = field.val();
            return !val || val.toString().trim() === "" || val === "------------";
        }
        });
    }

    // Save filters to localStorage for persistence
    function saveFilters() {
        const filters = {};
        $form.find("select, input[type=checkbox]").each(function () {
        const $el = $(this);
        filters[$el.attr("id")] = $el.is(":checkbox") ? $el.prop("checked") : $el.val();
        });
        localStorage.setItem("targetGroupFilters", JSON.stringify(filters));
    }

    // Clear filters from localStorage
    function clearFiltersStorage() {
        localStorage.removeItem("targetGroupFilters");
    }

    // Clear selected recipients from Set and localStorage
    function clearSelectedRecipients() {
        selectedRecipients.clear();
        localStorage.removeItem("selectedRecipients");
    }

    // Load saved filters from localStorage
    function loadFilters() {
        const saved = localStorage.getItem("targetGroupFilters");
        if (!saved) return;
        const filters = JSON.parse(saved);
        for (const id in filters) {
        const $el = $("#" + id);
        if ($el.length) {
            if ($el.is(":checkbox")) {
            $el.prop("checked", filters[id]);
            } else {
            $el.val(filters[id]);
            }
        }
        }
    }

    // Reset specific fields to defaults
    function resetFields(keys) {
        keys.forEach(key => {
        const field = fields[key];
        if (!field.length) return;
        if (field.is("select")) {
            field.val("");
        } else {
            field.find("input[type=checkbox]").prop("checked", false);
        }
        });
    }

    // Show or hide dependent fields based on branch selection
    function updateBranchVisibility() {
        if (fields.branch.val()) {
        $("#role-field").show();
        } else {
        $("#role-field, #staff-type-field, #teaching-positions-field, #non-teaching-positions-field, #student-class-field, #class-arm-field").hide();
        resetFields(["role", "staffType", "teaching", "nonTeaching", "studentClass", "classArm"]);
        }
    }

    // Show or hide fields depending on role selection
    function updateRoleVisibility() {
        const role = fields.role.val();

        if (role === "staff") {
        $("#staff-type-field").show();
        updateStaffTypeVisibility();
        } else {
        $("#staff-type-field, #teaching-positions-field, #non-teaching-positions-field").hide();
        resetFields(["staffType", "teaching", "nonTeaching"]);
        }

        checkIfClassTeacherSelected();
    }

    // Show/hide teaching/non-teaching position fields depending on staffType
    function updateStaffTypeVisibility() {
        const type = fields.staffType.val();
        const $teaching = $("#teaching-positions-field");
        const $nonTeaching = $("#non-teaching-positions-field");

        if (type === "teaching") {
        $teaching.show();
        $nonTeaching.hide().find("input[type=checkbox]").prop("checked", false);
        } else if (type === "non_teaching") {
        $nonTeaching.show();
        $teaching.hide().find("input[type=checkbox]").prop("checked", false);
        } else if (type === "both") {
        $teaching.show();
        $nonTeaching.show();
        } else {
        $teaching.hide().find("input[type=checkbox]").prop("checked", false);
        $nonTeaching.hide().find("input[type=checkbox]").prop("checked", false);
        }

        checkIfClassTeacherSelected();
    }

    // Show/hide class arm field based on student class
    function updateStudentClassVisibility() {
        const show = !!fields.studentClass.val();
        $("#class-arm-field").toggle(show);
        if (!show) fields.classArm.val("");
    }

    // Save selected recipients Set to localStorage
    function saveSelectedRecipients() {
        localStorage.setItem("selectedRecipients", JSON.stringify([...selectedRecipients]));
    }

    // Load selected recipients Set from localStorage
    function loadSelectedRecipients() {
        const saved = localStorage.getItem("selectedRecipients");
        selectedRecipients = saved ? new Set(JSON.parse(saved)) : new Set();
    }

    // Update checkboxes in the recipient table to reflect selectedRecipients Set
    function updateRecipientTableCheckboxStates() {
        $(".recipient-checkbox").each(function () {
        const id = $(this).val();
        $(this).prop("checked", selectedRecipients.has(id));
        });
        $selectAll.prop("checked", $(".recipient-checkbox").length > 0 && $(".recipient-checkbox:checked").length === $(".recipient-checkbox").length);
    }

    // Load filtered recipients via AJAX and populate table
    function loadRecipients() {
        const role = fields.role.val();
        const staffType = fields.staffType.val();
        const studentClass = fields.studentClass.val();
        const classArm = fields.classArm.val();
        const branch = fields.branch.val();

        const hasTeaching = fields.teaching.find("input:checked").length > 0;
        const hasNonTeaching = fields.nonTeaching.find("input:checked").length > 0;

        // Determine if class teacher is selected
        const isClassTeacherSelected = ["teaching", "both"].includes(staffType) && $("#id_teaching_positions input[type=checkbox]:checked").toArray()
        .some(cb => $(cb).data("is-class-teacher") == "1");

        // Build query data for AJAX
        let queryData = [];
        if (branch) queryData.push({ name: "branch", value: branch });
        if (role) queryData.push({ name: "role", value: role });
        if (staffType) queryData.push({ name: "staff_type", value: staffType });

        if (role === "staff") {
        if (["teaching", "both"].includes(staffType) && hasTeaching) {
            fields.teaching.find("input:checked").each(function () {
            queryData.push({ name: "teaching_positions", value: $(this).val() });
            });
        }
        if (["non_teaching", "both"].includes(staffType) && hasNonTeaching) {
            fields.nonTeaching.find("input:checked").each(function () {
            queryData.push({ name: "non_teaching_positions", value: $(this).val() });
            });
        }

        if ((["teaching"].includes(staffType) && !hasTeaching) ||
            (["non_teaching"].includes(staffType) && !hasNonTeaching) ||
            (["both"].includes(staffType) && !hasTeaching && !hasNonTeaching)) {
            recipientsTable.clear().draw();
            $recipientsTableBody.html(`<tr><td colspan="6" class="text-center p-4">
            Please select at least one ${staffType.replace("_", "-")} position.
            </td></tr>`);
            return;
        }
        }

        if (isClassTeacherSelected && studentClass) {
        queryData.push({ name: "student_class", value: studentClass });
        if (classArm) queryData.push({ name: "class_arm", value: classArm });
        }

        if (role === "student") {
        if (!studentClass) {
            recipientsTable.clear().draw();
            $recipientsTableBody.html('<tr><td colspan="6" class="text-center p-4">Please select class to view students.</td></tr>');
            return;
        }
        queryData.push({ name: "student_class", value: studentClass });
        if (classArm) queryData.push({ name: "class_arm", value: classArm });
        }

        // Filter out empty values
        queryData = queryData.filter(q => q.value !== undefined && q.value !== null && q.value !== "");

        // AJAX request to get filtered users
        $.get("{% url 'get_filtered_users' %}", $.param(queryData), function (response) {
        recipientsTable.clear();

        if (!response.length) {
            recipientsTable.draw();
            $selectAll.prop("checked", false);
            $recipientsTableBody.html('<tr><td colspan="6" class="text-center p-4">No users found.</td></tr>');
            return;
        }

        response.forEach((user, index) => {
            const profilePic = (user.profile_picture && user.profile_picture.url) || "/static/assets/img/profile-pic.png";
            const isChecked = selectedRecipients.has(user.id.toString());

            recipientsTable.row.add([
            `<input type="checkbox" class="recipient-checkbox" value="${user.id}" ${isChecked ? "checked" : ""}>`,
            index + 1,
            `<img src="${profilePic}" alt="Profile Picture" width="30" height="30" style="border-radius: 50%; object-fit: cover;">`,
            user.branch__name || "-",
            `${user.first_name} ${user.last_name}`,
            user.email,
            ]);
        });

        recipientsTable.draw();
        updateRecipientTableCheckboxStates();
        });
    }

    // Handle changes in filters: clear recipients and reload
    function handleDependencyChange() {
        clearSelectedRecipients();
        $selectAll.prop("checked", false);
        saveFilters();
        loadRecipients();
    }

    // Sync filter selections to hidden inputs for form submission
    function syncFilterDataToHiddenFields() {
        $("#hidden-branch").val(fields.branch.val() || "");
        $("#hidden-role").val(fields.role.val() || "");
        $("#hidden-staff-type").val(fields.staffType.val() || "");
        $("#hidden-student-class").val(fields.studentClass.val() || "");
        $("#hidden-class-arm").val(fields.classArm.val() || "");

        const teaching = Array.from($("#id_teaching_positions").find("input[type=checkbox]:checked")).map(cb => cb.value);
        const nonTeaching = Array.from($("#id_non_teaching_positions").find("input[type=checkbox]:checked")).map(cb => cb.value);
        $("#hidden-teaching-positions").val(teaching.join(","));
        $("#hidden-non-teaching-positions").val(nonTeaching.join(","));
    }

    // Check if class teacher is selected and toggle class-related fields
    function checkIfClassTeacherSelected() {
        const isClassTeacher = $("#id_teaching_positions input[type=checkbox]:checked").filter(function () {
        return $(this).data("is-class-teacher") == "1";
        }).length > 0;

        const shouldShowClassFields =
        fields.role.val() === "student" ||
        (fields.role.val() === "staff" && ["teaching", "both"].includes(fields.staffType.val()) && isClassTeacher);

        if (shouldShowClassFields) {
        $("#student-class-field").slideDown();
        $("#class-arm-field").slideDown();
        } else {
        $("#student-class-field").slideUp();
        $("#class-arm-field").slideUp();
        fields.studentClass.val("");
        fields.classArm.val("");
        }

        updateStudentClassVisibility();
    }

    // ===== Event Listeners =====
    $form.find("select, input[type=checkbox]").not("#select-all-recipients").on("change", handleDependencyChange);

    $recipientsTableBody.on("change", ".recipient-checkbox", function () {
        const id = $(this).val();
        if ($(this).is(":checked")) selectedRecipients.add(id);
        else selectedRecipients.delete(id);
        saveSelectedRecipients();
        updateRecipientTableCheckboxStates();
    });

    $selectAll.on("change", function () {
        const checked = this.checked;
        $(".recipient-checkbox").each(function () {
        $(this).prop("checked", checked);
        const id = $(this).val();
        if (checked) selectedRecipients.add(id);
        else selectedRecipients.delete(id);
        });
        saveSelectedRecipients();
    });

    // Specific change handlers to update visibility & reload
    fields.branch.on("change", () => {
        updateBranchVisibility();
        updateRoleVisibility();
        checkIfClassTeacherSelected();
        handleDependencyChange();
    });
    fields.role.on("change", () => {
        updateRoleVisibility();
        checkIfClassTeacherSelected();
        handleDependencyChange();
    });
    fields.staffType.on("change", () => {
        updateStaffTypeVisibility();
        checkIfClassTeacherSelected();
        handleDependencyChange();
    });
    fields.teaching.on("change", () => {
        checkIfClassTeacherSelected();
        handleDependencyChange();
    });
    fields.nonTeaching.on("change", () => {
        checkIfClassTeacherSelected();
        handleDependencyChange();
    });
    fields.studentClass.on("change", () => {
        updateStudentClassVisibility();
        handleDependencyChange();
    });
    fields.classArm.on("change", handleDependencyChange);

    // Save as Draft button validation
    $("#save-draft").on("click", function (e) {
        if (!$("#id_is_draft").is(":checked")) {
        e.preventDefault();
        Swal.fire({
            title: "Draft Not Checked",
            text: "Please check 'Save as Draft' before saving.",
            icon: "warning",
            confirmButtonColor: "#3085d6",
            confirmButtonText: "OK"
        });
        return false;
        }
        saveFilters();
        saveSelectedRecipients();
    });

    // Form submission validation
    $communicationForm.on("submit", function (e) {
        const isDraftChecked = $("#id_is_draft").is(":checked");
        const submitButton = document.activeElement;

        if ($(submitButton).val() === "send" && isDraftChecked) {
        e.preventDefault();
        Swal.fire({
            title: "Draft is Checked",
            text: "You cannot send a message while 'Save as Draft' is checked. Please uncheck it to proceed.",
            icon: "error",
            confirmButtonColor: "#3085d6",
            confirmButtonText: "OK"
        });
        return false;
        }

        if (["staff", "branch_admin", "superadmin"].includes(userRole) && !fields.branch.val()) {
        e.preventDefault();
        Swal.fire({
            title: "Missing Branch",
            text: "Please select a Branch before submitting the form.",
            icon: "warning",
            confirmButtonColor: "#3085d6",
            confirmButtonText: "OK"
        });
        return false;
        }

        if (["student", "parent"].includes(userRole) && !fields.role.val()) {
        e.preventDefault();
        Swal.fire({
            title: "Missing Role",
            text: "Please select a Role before submitting the form.",
            icon: "warning",
            confirmButtonColor: "#3085d6",
            confirmButtonText: "OK"
        });
        return false;
        }

        // Inject selected filters into communication form as hidden inputs
        $communicationForm.find(".injected-filter-field").remove();
        const filterNames = ["branch", "role", "staff_type", "teaching_positions", "non_teaching_positions", "student_class", "class_arm"];

        filterNames.forEach(name => {
        const $fields = $form.find(`[name='${name}']`);
        if ($fields.length) {
            if ($fields.first().attr("type") === "checkbox") {
            $fields.filter(":checked").each(function () {
                $("<input>", {
                type: "hidden",
                name,
                value: $(this).val(),
                class: "injected-filter-field"
                }).appendTo($communicationForm);
            });
            } else {
            const val = $fields.val();
            if (Array.isArray(val)) {
                val.forEach(item => {
                $("<input>", {
                    type: "hidden",
                    name,
                    value: item,
                    class: "injected-filter-field"
                }).appendTo($communicationForm);
                });
            } else if (val) {
                $("<input>", {
                type: "hidden",
                name,
                value: val,
                class: "injected-filter-field"
                }).appendTo($communicationForm);
            }
            }
        }
        });

        // Inject selected recipients
        $communicationForm.find('input[name="selected_recipients"]').remove();
        [...selectedRecipients].forEach(id => {
        $("<input>", {
            type: "hidden",
            name: "selected_recipients",
            value: id
        }).appendTo($communicationForm);
        });

        // Clear storage if final send
        const isFinalSend = $("#id_status").val() === "sent";
        if (isFinalSend) {
        clearFiltersStorage();
        localStorage.removeItem("selectedRecipients");
        }

        syncFilterDataToHiddenFields();

        // Unbind and resubmit form to prevent double handling
        $communicationForm.off("submit").submit();
    });

    // ===== Attachment Handling =====
    const maxAttachments = 5;
    let totalForms = parseInt($("#id_attachments-TOTAL_FORMS").val());

    $("#add-attachment").on("click", function () {
        if (totalForms >= maxAttachments) {
        alert("Maximum attachments reached.");
        return;
        }
        const $newForm = $(".attachment-form:first").clone();
        $newForm.find("input, select, textarea").each(function () {
        const name = $(this).attr("name").replace("-0-", `-${totalForms}-`);
        const id = "id_" + name;
        $(this).attr({ name, id }).val("");
        if ($(this).is(":checkbox, :radio")) $(this).prop("checked", false);
        });
        $newForm.find(".remove-attachment").remove();
        $newForm.append(`
        <button type="button" class="btn btn-sm btn-danger remove-attachment" 
                style="position: absolute; top: 8px; right: 8px; font-size: 0.75rem; padding: 2px 6px;">
            <i class="fas fa-times"></i>
        </button>
        `);
        $("#attachments-container").append($newForm);
        totalForms++;
        $("#id_attachments-TOTAL_FORMS").val(totalForms);
    });

    $("#attachments-container").on("click", ".remove-attachment", function () {
        const $form = $(this).closest(".attachment-form");
        const $deleteCheckbox = $form.find("input[type=checkbox][name$='-DELETE']");
        const $idField = $form.find("input[type=hidden][name$='-id']");
        
        if ($idField.length && $idField.val()) {
            // Existing form: mark for deletion and hide visually
            $deleteCheckbox.prop("checked", true);
            $form.hide();
        } else {
            // New form: remove from DOM and decrement total forms
            $form.remove();
            totalForms--;
            $("#id_attachments-TOTAL_FORMS").val(totalForms);
        }
    });


    // ===== Initial Setup =====
    loadFilters();
    updateBranchVisibility();
    updateRoleVisibility();
    updateStaffTypeVisibility();
    checkIfClassTeacherSelected();
    updateStudentClassVisibility();
    loadSelectedRecipients();
    loadRecipients();
    syncFilterDataToHiddenFields();
    });
</script>

{% endblock %}
