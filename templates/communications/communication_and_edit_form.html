{% extends 'base.html' %}
{% load static %}

{% block content %}

<div class="container-fluid py-3">

    <!-- Page Heading -->
    <h2 class="mb-4 text-success d-flex align-items-center">
        <i class="fas fa-plus-circle me-2"></i>
        {% if editing_draft %} Edit Communication Draft {% else %} Create Communication {% endif %}
    </h2>

    <style>
        #form-fields-container {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            background-color: #f2f3f5;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        #form-fields-container legend {
            font-weight: 600;
            font-size: 1.1rem;
            flex-basis: 100%;
            margin-bottom: 1rem;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            min-width: 180px;
            flex-grow: 1;
        }
        .table thead {
            background-color: #007bff;
            color: white;
        }
        .attachment-form {
            border: 1px dashed #ccc;
            padding: 0.75rem;
            border-radius: 5px;
            background-color: white;
            position: relative;
        }
        .remove-attachment {
            position: absolute;
            top: 8px;
            right: 8px;
        }
    </style>

    <!-- Target Group Filter Form -->
    <form id="target-group-form" method="get" class="mb-4">
        <fieldset id="form-fields-container">
            <legend>Select Target Group</legend>

            {% if user_role != "student" and user_role != "parent" %}
                <div id="branch-field" class="form-group">
                    <label for="id_branch" class="form-label">Branch:</label>
                    {{ target_group_form.branch }}
                    {% if target_group_form.branch.errors %}
                        <div class="text-danger small">{{ target_group_form.branch.errors }}</div>
                    {% endif %}
                </div>
            {% else %}
                <input type="hidden" id="id_branch" name="branch" value="{{ user_branch_id }}">
            {% endif %}

            <div id="role-field" class="form-group d-none">
                <label for="{{ target_group_form.role.id_for_label }}" class="form-label">{{ target_group_form.role.label }}:</label>
                {{ target_group_form.role }}
                {% if target_group_form.role.errors %}
                    <div class="text-danger small">{{ target_group_form.role.errors }}</div>
                {% endif %}
            </div>
        </fieldset>
    </form>

    <!-- Communication Form -->
    <form id="communication-form" method="post" enctype="multipart/form-data" data-user-role="{{ request.user.role }}">
        {% csrf_token %}

        {% if form_error %}
            <div class="alert alert-warning">Please correct the highlighted fields below.</div>
        {% endif %}
        {% if attachment_formset.non_form_errors %}
            <div class="alert alert-danger">{{ attachment_formset.non_form_errors }}</div>
        {% endif %}
        {% if communication_form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in communication_form.non_field_errors %}
                    <div>{{ error }}</div>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Recipients Table -->
        <h3 class="mb-3">Filtered Recipients</h3>
        <div class="table-responsive">
            <table id="recipients-table" class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th class="text-center"><input type="checkbox" id="select-all-recipients"></th>
                        <th class="text-center">S/N</th>
                        <th class="text-center">Profile Picture</th>
                        <th class="text-center">Branch</th>
                        <th>Name</th>
                        <th>Email</th>
                    </tr>
                </thead>
                <tbody>
                    {% if recipients %}
                        {% for user in recipients %}
                            <tr>
                                <td class="text-center">
                                    <input type="checkbox" name="selected_recipients" value="{{ user.id }}"
                                        {% if user.id|stringformat:"s" in selected_recipient_ids %}checked{% endif %}>
                                </td>
                                <td class="text-center">{{ forloop.counter }}</td>
                                <td class="text-center">
                                    {% if user.profile_picture %}
                                        <img src="{{ user.profile_picture.url }}" class="rounded-circle" style="width:40px; height:40px;">
                                    {% else %}
                                        <i class="fas fa-user-circle fa-2x text-muted"></i>
                                    {% endif %}
                                </td>
                                <td class="text-center">{{ user.branch.name }}</td>
                                <td>{{ user.get_full_name }}</td>
                                <td>{{ user.email }}</td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                          <td></td>
                          <td></td>
                          <td></td>
                          <td colspan="6" class="text-center text-muted fst-italic">Select filters above to view recipients.</td>
                          <td></td>
                          <td></td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <!-- Message & Attachment Section -->
        <div class="row g-3 bg-light p-3 rounded">
            <!-- Message Details -->
            <div class="col-lg-8">
                <fieldset class="border p-3 rounded">
                    <legend class="fw-semibold">Message Details</legend>
                    {% for field in communication_form %}
                        {% if field.name not in exclude_fields %}
                            <div class="mb-3">
                                <label for="{{ field.id_for_label }}" class="form-label fw-semibold">{{ field.label }}</label>
                                {{ field }}
                                {% if field.help_text %}
                                    <small class="form-text text-muted">{{ field.help_text }}</small>
                                {% endif %}
                                {% if field.errors %}
                                    <div class="text-danger small">{{ field.errors }}</div>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </fieldset>
            </div>

            <!-- Attachments -->
            <div class="col-lg-4">
                <fieldset class="border p-3 rounded">
                    <legend class="fw-semibold">Attachments</legend>
                    {{ attachment_formset.management_form }}
                    <div id="attachments-container">
                        {% for form in attachment_formset.forms %}
                            <div class="attachment-form mb-2 {% if forloop.counter > 1 %}extra-attachment{% endif %}">
                                {{ form.as_p }}
                                {% if forloop.counter > 1 %}
                                    <button type="button" class="btn btn-sm btn-danger remove-attachment">
                                        <i class="fas fa-times"></i>
                                    </button>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                    <button type="button" id="add-attachment" class="btn btn-success btn-sm mt-2">
                        <i class="fas fa-plus me-1"></i> Add More Files
                    </button>
                </fieldset>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-4">
            <button type="submit" class="btn btn-primary me-2" name="action" value="draft" id="save-draft">
                {% if editing_draft %} Update Draft {% else %} Save as Draft {% endif %}
            </button>
            <button type="submit" class="btn btn-success" name="action" value="send">
                Send Message
            </button>
        </div>

    </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  $(document).ready(function () {
    // Cached jQuery selectors and variables
    const $form = $("#target-group-form");
    const $recipientsTableBody = $("#recipients-table tbody");
    const $selectAll = $("#select-all-recipients");
    const $communicationForm = $("#communication-form");
    const userRole = $communicationForm.data("user-role");

    const fields = {
      branch: $("#id_branch"),
      role: $("#id_role"),
      staffType: $("#id_staff_type"),
      teaching: $("#id_teaching_positions"),
      nonTeaching: $("#id_non_teaching_positions"),
      studentClass: $("#id_student_class"),
      classArm: $("#id_class_arm"),
    };

    let selectedRecipients = new Set();

    // Initialize DataTable or get existing instance
    let recipientsTable;
    if (!$.fn.DataTable.isDataTable("#recipients-table")) {
      recipientsTable = $("#recipients-table").DataTable({
        columnDefs: [{ targets: 0, orderable: false, searchable: false }],
        order: [[1, "asc"]],
      });
    } else {
      recipientsTable = $("#recipients-table").DataTable();
    }

    // Utility Functions
    function saveFilters() {
      const filters = {};
      $form.find("select, input[type=checkbox]").each(function () {
        const $el = $(this);
        filters[$el.attr("id")] = $el.is(":checkbox") ? $el.prop("checked") : $el.val();
      });
      localStorage.setItem("targetGroupFilters", JSON.stringify(filters));
    }

    function clearFiltersStorage() {
      localStorage.removeItem("targetGroupFilters");
    }

    function clearSelectedRecipients() {
      selectedRecipients.clear();
      localStorage.removeItem("selectedRecipients");
    }

    function loadFilters() {
      const saved = localStorage.getItem("targetGroupFilters");
      if (!saved) return;
      const filters = JSON.parse(saved);
      for (const id in filters) {
        const $el = $("#" + id);
        if ($el.length) {
          if ($el.is(":checkbox")) {
            $el.prop("checked", filters[id]);
          } else {
            $el.val(filters[id]);
          }
        }
      }
    }

    function resetFields(keys) {
      keys.forEach((key) => {
        const field = fields[key];
        if (field.is("select")) {
          field.val("");
        } else {
          field.find("input[type=checkbox]").prop("checked", false);
        }
      });
    }

    // Show/hide fields based on selections
    function updateBranchVisibility() {
      if (fields.branch.val()) {
        $("#role-field").show();
      } else {
        $("#role-field, #staff-type-field, #teaching-positions-field, #non-teaching-positions-field, #student-class-field, #class-arm-field").hide();
        resetFields(["role", "staffType", "teaching", "nonTeaching", "studentClass", "classArm"]);
      }
    }

    function updateRoleVisibility() {
      const role = fields.role.val();

      if (role === "staff") {
        $("#staff-type-field").show();
        updateStaffTypeVisibility();
      } else if (role === "student") {
        $("#staff-type-field, #teaching-positions-field, #non-teaching-positions-field").hide();
        resetFields(["staffType", "teaching", "nonTeaching"]);
      } else {
        $("#staff-type-field, #teaching-positions-field, #non-teaching-positions-field").hide();
        resetFields(["staffType", "teaching", "nonTeaching"]);
      }
      checkIfClassTeacherSelected();
    }

    function updateStaffTypeVisibility() {
      const type = fields.staffType.val();
      const $teaching = $("#teaching-positions-field");
      const $nonTeaching = $("#non-teaching-positions-field");

      if (type === "teaching") {
        $teaching.show();
        $nonTeaching.hide().find("input[type=checkbox]").prop("checked", false);
      } else if (type === "non_teaching") {
        $nonTeaching.show();
        $teaching.hide().find("input[type=checkbox]").prop("checked", false);
      } else if (type === "both") {
        $teaching.show();
        $nonTeaching.show();
      } else {
        $teaching.hide().find("input[type=checkbox]").prop("checked", false);
        $nonTeaching.hide().find("input[type=checkbox]").prop("checked", false);
      }
      checkIfClassTeacherSelected();
    }

    function updateStudentClassVisibility() {
      const show = !!fields.studentClass.val();
      $("#class-arm-field").toggle(show);
      if (!show) fields.classArm.val("");
    }

    // Recipient selection & table updates
    function saveSelectedRecipients() {
      localStorage.setItem("selectedRecipients", JSON.stringify([...selectedRecipients]));
    }

    function loadSelectedRecipients() {
      selectedRecipients = new Set(JSON.parse(localStorage.getItem("selectedRecipients") || "[]"));
    }

    function updateRecipientTableCheckboxStates() {
      $(".recipient-checkbox").each(function () {
        const id = $(this).val();
        $(this).prop("checked", selectedRecipients.has(id));
      });
      $selectAll.prop("checked", $(".recipient-checkbox:checked").length === $(".recipient-checkbox").length);
    }

    function loadRecipients() {
      const role = fields.role.val();
      const staffType = fields.staffType.val();
      const studentClass = fields.studentClass.val();
      const classArm = fields.classArm.val();
      const branch = fields.branch.val();

      const hasTeaching = fields.teaching.find("input:checked").length > 0;
      const hasNonTeaching = fields.nonTeaching.find("input:checked").length > 0;

      let isClassTeacherSelected = false;
      if (["teaching", "both"].includes(staffType)) {
        isClassTeacherSelected = $("#id_teaching_positions input[type=checkbox]:checked").toArray()
          .some(cb => $(cb).data("is-class-teacher") == "1");
      }

      const queryData = [];

      if (branch) queryData.push({ name: "branch", value: branch });
      if (role) queryData.push({ name: "role", value: role });
      if (staffType) queryData.push({ name: "staff_type", value: staffType });

      if (role === "staff") {
        if (["teaching", "both"].includes(staffType) && hasTeaching) {
          fields.teaching.find("input:checked").each(function () {
            queryData.push({ name: "teaching_positions", value: $(this).val() });
          });
        }
        if (["non_teaching", "both"].includes(staffType) && hasNonTeaching) {
          fields.nonTeaching.find("input:checked").each(function () {
            queryData.push({ name: "non_teaching_positions", value: $(this).val() });
          });
        }

        if (
          (["teaching"].includes(staffType) && !hasTeaching) ||
          (["non_teaching"].includes(staffType) && !hasNonTeaching) ||
          (["both"].includes(staffType) && !hasTeaching && !hasNonTeaching)
        ) {
          recipientsTable.clear().draw();
          $recipientsTableBody.html(`<tr><td colspan="6" class="text-center p-4">
            Please select at least one ${staffType.replace("_", "-")} position.
          </td></tr>`);
          return;
        }
      }

      if (isClassTeacherSelected && studentClass) {
        queryData.push({ name: "student_class", value: studentClass });
        if (classArm) queryData.push({ name: "class_arm", value: classArm });
      }

      if (role === "student") {
        if (!studentClass) {
          recipientsTable.clear().draw();
          $recipientsTableBody.html('<tr><td colspan="6" class="text-center p-4">Please select class to view students.</td></tr>');
          return;
        }
        queryData.push({ name: "student_class", value: studentClass });
        if (classArm) queryData.push({ name: "class_arm", value: classArm });
      }

      const cleanQueryData = queryData.filter(q => q.value !== undefined && q.value !== null && q.value !== "");

      $.get("{% url 'get_filtered_users' %}", $.param(cleanQueryData), function (response) {
        recipientsTable.clear();

        if (!response.length) {
          recipientsTable.draw();
          $selectAll.prop("checked", false);
          $recipientsTableBody.html('<tr><td colspan="6" class="text-center p-4">No users found.</td></tr>');
          return;
        }

        response.forEach((user, index) => {
          const profilePic = (user.profile_picture && user.profile_picture.url) || "/static/assets/img/profile-pic.png";
          const isChecked = selectedRecipients.has(user.id.toString());

          recipientsTable.row.add([
            `<input type="checkbox" class="recipient-checkbox" value="${user.id}" ${isChecked ? "checked" : ""}>`,
            index + 1,
            `<img src="${profilePic}" alt="Profile Picture" width="30" height="30" style="border-radius: 50%; object-fit: cover;">`,
            user.branch__name || "-",
            `${user.first_name} ${user.last_name}`,
            user.email,
          ]);
        });

        recipientsTable.draw();
        updateRecipientTableCheckboxStates();
      });
    }

    // Show/hide class fields based on class teacher selection
    function checkIfClassTeacherSelected() {
      const isClassTeacher = $("#id_teaching_positions input[type=checkbox]:checked").filter(function () {
        return $(this).data("is-class-teacher") == "1";
      }).length > 0;

      const shouldShowClassFields =
        fields.role.val() === "student" ||
        (fields.role.val() === "staff" && ["teaching", "both"].includes(fields.staffType.val()) && isClassTeacher);

      if (shouldShowClassFields) {
        $("#student-class-field").slideDown();
        $("#class-arm-field").slideDown();
      } else {
        $("#student-class-field").slideUp();
        $("#class-arm-field").slideUp();
        fields.studentClass.val("");
        fields.classArm.val("");
      }

      updateStudentClassVisibility();
    }

    // Handle change on filters - clear selections and reload recipients
    function handleDependencyChange() {
      clearSelectedRecipients();
      $selectAll.prop("checked", false);
      saveFilters();
      loadRecipients();
    }

    // Event Listeners
    $form.find("select, input[type=checkbox]").not("#select-all-recipients").on("change", handleDependencyChange);

    $recipientsTableBody.on("change", ".recipient-checkbox", function () {
      const id = $(this).val();
      if ($(this).is(":checked")) {
        selectedRecipients.add(id);
      } else {
        selectedRecipients.delete(id);
      }
      saveSelectedRecipients();
      updateRecipientTableCheckboxStates();
    });

    $selectAll.on("change", function () {
      const checked = this.checked;
      $(".recipient-checkbox").each(function () {
        $(this).prop("checked", checked);
        const id = $(this).val();
        checked ? selectedRecipients.add(id) : selectedRecipients.delete(id);
      });
      saveSelectedRecipients();
    });

    // Save as Draft button validation
    $("#save-draft").on("click", function (e) {
      const isDraftChecked = $("#id_is_draft").is(":checked");
      if (!isDraftChecked) {
        e.preventDefault();
        Swal.fire({
          title: "Draft Not Checked",
          text: "Please check 'Save as Draft' before saving.",
          icon: "warning",
          confirmButtonColor: "#3085d6",
          confirmButtonText: "OK"
        });
        return false;
      }
      saveFilters();
      saveSelectedRecipients();
    });

    // Form submission validation
    $communicationForm.on("submit", function (e) {
      const isDraftChecked = $("#id_is_draft").is(":checked");
      const submitButton = document.activeElement;

      if ($(submitButton).val() === "send" && isDraftChecked) {
        e.preventDefault();
        Swal.fire({
          title: "Draft is Checked",
          text: "You cannot send a message while 'Save as Draft' is checked. Please uncheck it to proceed.",
          icon: "error",
          confirmButtonColor: "#3085d6",
          confirmButtonText: "OK"
        });
        return false;
      }

      if (["staff", "branch_admin", "superadmin"].includes(userRole) && !fields.branch.val()) {
        e.preventDefault();
        Swal.fire({
          title: "Missing Branch",
          text: "Please select a Branch before submitting the form.",
          icon: "warning",
          confirmButtonColor: "#3085d6",
          confirmButtonText: "OK"
        });
        return false;
      }

      if (["student", "parent"].includes(userRole) && !fields.role.val()) {
        e.preventDefault();
        Swal.fire({
          title: "Missing Role",
          text: "Please select a Role before submitting the form.",
          icon: "warning",
          confirmButtonColor: "#3085d6",
          confirmButtonText: "OK"
        });
        return false;
      }

      // Inject filter values into communication form before submit
      $communicationForm.find(".injected-filter-field").remove();
      const filterFieldNames = [
        "branch",
        "role",
        "staff_type",
        "teaching_positions",
        "non_teaching_positions",
        "student_class",
        "class_arm"
      ];

      filterFieldNames.forEach(name => {
        const $fields = $form.find(`[name='${name}']`);
        if ($fields.length && $fields[0].type === "checkbox") {
          $fields.filter(":checked").each(function () {
            $("<input>", {
              type: "hidden",
              name,
              value: $(this).val(),
              class: "injected-filter-field"
            }).appendTo($communicationForm);
          });
        } else {
          const val = $fields.val();
          if (Array.isArray(val)) {
            val.forEach(item => {
              $("<input>", {
                type: "hidden",
                name,
                value: item,
                class: "injected-filter-field"
              }).appendTo($communicationForm);
            });
          } else if (val !== undefined && val !== null && val !== "") {
            $("<input>", {
              type: "hidden",
              name,
              value: val,
              class: "injected-filter-field"
            }).appendTo($communicationForm);
          }
        }
      });

      // Inject selected recipients into the form
      $communicationForm.find('input[name="selected_recipients"]').remove();
      [...selectedRecipients].forEach(id => {
        $("<input>", {
          type: "hidden",
          name: "selected_recipients",
          value: id
        }).appendTo($communicationForm);
      });

      // Clear storage if final send
      const isFinalSend = $("#id_status").val() === "sent";
      if (isFinalSend) {
        clearFiltersStorage();
        localStorage.removeItem("selectedRecipients");
      }

      syncFilterDataToHiddenFields();

      // Unbind and submit to prevent double submit
      $communicationForm.off("submit").submit();
    });

    // Attachment handling logic
    const maxAttachments = 5;
    let totalForms = parseInt($("#id_attachments-TOTAL_FORMS").val());

    $("#add-attachment").on("click", function () {
      if (totalForms >= maxAttachments) return alert("Maximum attachments reached.");
      const $newForm = $(".attachment-form:first").clone();

      $newForm.find("input, select, textarea").each(function () {
        const name = $(this).attr("name").replace("-0-", `-${totalForms}-`);
        const id = "id_" + name;
        $(this).attr({ name, id }).val("");
        if ($(this).is(":checkbox, :radio")) $(this).prop("checked", false);
      });

      $newForm.find(".remove-attachment").remove();
      $newForm.append(`
        <button type="button" class="btn btn-sm btn-danger remove-attachment" 
                style="position: absolute; top: 8px; right: 8px; font-size: 0.75rem; padding: 2px 6px;">
          <i class="fas fa-times"></i>
        </button>
      `);

      $("#attachments-container").append($newForm);
      totalForms++;
      $("#id_attachments-TOTAL_FORMS").val(totalForms);
    });

    $("#attachments-container").on("click", ".remove-attachment", function () {
      $(this).closest(".attachment-form").remove();
      totalForms--;
      $("#id_attachments-TOTAL_FORMS").val(totalForms);
    });

    // Sync filters to hidden inputs for form submit (for backend)
    function syncFilterDataToHiddenFields() {
      $("#hidden-branch").val(fields.branch.val() || "");
      $("#hidden-role").val(fields.role.val() || "");
      $("#hidden-staff-type").val(fields.staffType.val() || "");
      $("#hidden-student-class").val(fields.studentClass.val() || "");
      $("#hidden-class-arm").val(fields.classArm.val() || "");

      const teachingVals = fields.teaching.find("input:checked").map(function () { return $(this).val(); }).get();
      const nonTeachingVals = fields.nonTeaching.find("input:checked").map(function () { return $(this).val(); }).get();

      $("#hidden-teaching-positions").val(teachingVals.join(","));
      $("#hidden-non-teaching-positions").val(nonTeachingVals.join(","));
    }

    // Initial setup on page load
    loadFilters();
    updateBranchVisibility();
    updateRoleVisibility();
    updateStaffTypeVisibility();
    checkIfClassTeacherSelected();
    updateStudentClassVisibility();
    loadSelectedRecipients();
    loadRecipients();
    syncFilterDataToHiddenFields();
  });
</script>

{% endblock %}
