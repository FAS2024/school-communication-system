{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-5">
  <div class="card shadow-sm rounded-4 border-0">

    <!-- Header: dark charcoal -->
    <div class="px-4 py-3 rounded-top-4" style="background-color:#2c2c2c; color:#f5f5f5;">
      <h4 class="mb-0 d-flex align-items-center gap-2" style="font-weight: 600;">
        <i class="fas fa-envelope-open-text" style="color:#f5a623;"></i>
        {{ message.title|default:"(Untitled)" }}
      </h4>
    </div>

    <div class="card-body px-5 py-4" style="background-color:#ddd;">

      <!-- Sender Info -->
      <section class="d-flex align-items-center gap-3 border-bottom pb-3 mb-4" style="border-color:red;">
        {% if message.sender.profile_picture %}
          <img src="{{ message.sender.profile_picture.url }}" alt="Sender" width="50" height="50" class="rounded-circle object-fit-cover shadow-sm" />
        {% else %}
          <img src="{% static 'assets/img/profile-pic.png' %}" alt="Default" width="50" height="50" class="rounded-circle object-fit-cover shadow-sm" />
        {% endif %}
        <div>
          <p class="mb-1" style="font-weight: 600; color:black;">
            {{ message.sender.get_full_name|default:"(No name)" }}
          </p>
          <small class="text-muted text-capitalize" style="display:block;">
            {{ message.sender.role|default:"Unknown role" }}
          </small>
          <small class="text-muted d-block mt-1" style="font-size:0.9rem;">
            <strong>Email:</strong> {{ message.sender.email|default:"N/A" }}<br/>
            {% if message.sender.branch %}
              <strong>Branch:</strong> {{ message.sender.branch.name }}
            {% endif %}
          </small>
        </div>
      </section>

      <!-- Dates & Type -->
      <section class="d-flex flex-wrap gap-4 text-muted small mb-4" style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
        <div>
          <i class="fas fa-clock me-1"></i>
          Sent: {{ message.created_at|date:"D, M d, Y - h:i A" }}
        </div>
        {% if message.scheduled_time %}
          <div>
            <i class="fas fa-calendar-alt me-1"></i>
            Scheduled: {{ message.scheduled_time|date:"D, M d, Y - h:i A" }}
          </div>
        {% endif %}
        <div>
          <i class="fas fa-tag me-1"></i>
          Type: <span style="background:#f5a623; color:#222; padding: 2px 10px; border-radius: 15px; font-weight: 600; text-transform: capitalize;">{{ message.message_type|default:"general" }}</span>
        </div>
      </section>

      <!-- Message Body -->
      <article class="p-4 rounded-3 mb-4" style="background:white; border:1px solid #ccc; font-size: 1rem; line-height: 1.5; color:#444; white-space: pre-wrap;">
        {{ message.body|linebreaks }}
      </article>

      <!-- Attachments -->
      {% if message.attachments.exists %}
      <section class="mb-4">
        <h6 style="color:black; font-weight: 600; margin-bottom: 0.75rem;">
          <i class="fas fa-paperclip me-2" style="color:green;"></i><strong>Attachments</strong>
        </h6>
        <ul class="list-unstyled ps-3">
          {% for attachment in message.attachments.all %}
          <li class="mb-2">
            <a href="{% url 'download_attachment' attachment.pk %}" class="text-decoration-none d-flex align-items-center gap-1" style="color:#007bff;">
              <i class="fas fa-file-alt" style="color:#0056b3;"></i>
              <span>{{ attachment.basename }}</span>
              <i class="fas fa-download ms-2" style="color:#007bff;"></i>
            </a>
          </li>
          {% endfor %}
        </ul>
      </section>
      {% endif %}

      <!-- Reply Section -->
      {% if recipient_entry.requires_response %}
      <section class="mt-5">
        <h6 class="fw-bold text-dark mb-3">
          <i class="fas fa-reply me-2 text-warning"></i>
          Response Required
        </h6>

        {% if not recipient_entry.has_responded %}
          <form method="post" action="{% url 'submit_reply' recipient_entry.id %}" enctype="multipart/form-data" class="mb-4" id="reply-form">
            {% csrf_token %}

            <!-- Reply Text -->
            <div class="mb-3">
              <textarea name="reply" rows="4" class="form-control shadow-sm" placeholder="Write your reply here..." required></textarea>
            </div>

            <!-- Attachments Section Using Formset -->
            <fieldset>
              <h6 style="color:black; font-weight: 600; margin-bottom: 0.75rem;">
                <i class="fas fa-paperclip me-2" style="color:green;"></i><strong>Attachments for Response</strong>
              </h6>
              {{ attachment_formset.management_form }}
              <div id="attachments-container">
                {% for form in attachment_formset.forms %}
                  <div class="attachment-form mb-2 position-relative">
                    {{ form.file.label_tag }} {{ form.file }}
                    {% if form.DELETE %}{{ form.DELETE }}{% endif %}
                    <button type="button" class="btn btn-sm btn-danger remove-attachment mt-1">Remove</button>

                  </div>
                {% endfor %}
              </div>
              <button type="button" id="add-attachment" class="btn btn-sm btn-outline-success mt-2">
                + Add More Files
              </button>
            </fieldset>

            <!-- Upload spinner -->
            <div id="upload-spinner" style="display:none; margin-top: 10px;">
              <img src="{% static 'assets/img/spinner.gif' %}" alt="Uploading..." width="40" />
              Uploading files, please wait...
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-start gap-3 mt-4">
              <button type="submit" class="btn btn-success d-flex align-items-center gap-2" id="send-reply-btn">
                <i class="fas fa-paper-plane"></i> Send Reply
              </button>
              <a href="{% url 'inbox' %}" class="btn btn-outline-secondary d-flex align-items-center gap-2">
                <i class="fas fa-arrow-left"></i> Back to Inbox
              </a>
            </div>
            
          </form>

        {% else %}
        <div class="alert alert-success">
          <strong>You have already responded.</strong>
        </div>

        {% for reply in recipient_entry.replies.all %}
          <div class="border rounded-3 p-3 bg-white shadow-sm mt-3">
            <strong>Your Reply:</strong>
            <p class="mb-1">{{ reply.reply_text }}</p>
            <small class="text-muted">Replied on: {{ reply.replied_at|date:"D, M d, Y - h:i A" }}</small>

            {% if reply.attachments.exists %}
              <div class="mt-2">
                <strong class="d-block mb-1">Attachments:</strong>
                {% for att in reply.attachments.all %}
                  <a href="{{ att.file.url }}" class="d-block text-decoration-none" target="_blank">
                    <i class="fas fa-paperclip me-1 text-muted"></i> {{ att.file.name }}
                  </a>
                {% endfor %}
              </div>
            {% endif %}
          </div>

        {% endfor %}

        <div class="mt-4 d-flex justify-content-start gap-3">
          <a href="{% url 'inbox' %}" class="btn btn-outline-secondary d-flex align-items-center gap-2">
            <i class="fas fa-arrow-left"></i> Back to Inbox
          </a>
        </div>

        {% endif %}
      </section>
      {% else %}
      <!-- Only show back/delete if no reply is required -->
      <div class="d-flex flex-wrap gap-3 justify-content-start mt-4">
        <form method="post" action="{% url 'delete_message' message.pk %}" class="delete-form m-0">
          {% csrf_token %}
          <button type="submit" class="btn btn-outline-danger d-flex align-items-center gap-2 fw-semibold">
            <i class="fas fa-trash-alt"></i> Delete Message
          </button>
        </form>
        <a href="{% url 'inbox' %}" class="btn btn-outline-secondary d-flex align-items-center gap-2 fw-semibold">
          <i class="fas fa-arrow-left"></i> Back to Inbox
        </a>
      </div>
      {% endif %}

    </div>
  </div>
</div>

<!-- SweetAlert2 Script -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // DELETE CONFIRMATION
    document.querySelectorAll(".delete-form").forEach(form => {
      form.addEventListener("submit", function (e) {
        e.preventDefault();
        Swal.fire({
          title: "Are you sure?",
          text: "This message will be permanently deleted!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#3085d6",
          confirmButtonText: "Yes, delete it!",
          reverseButtons: true
        }).then(result => {
          if (result.isConfirmed) {
            form.submit();
          }
        });
      });
    });

    // REPLY CONFIRMATION (only if not empty)
    const replyForm = document.getElementById("reply-form");
    const replyBtn = document.getElementById("send-reply-btn");
    const fileInput = document.getElementById('file-upload');
    const preview = document.getElementById('file-preview');
    const spinner = document.getElementById('upload-spinner');
    const maxFiles = {{ MAX_ATTACHMENT_COUNT }};
    const maxSizeMB = {{ MAX_SINGLE_ATTACHMENT_MB }};
    const allowedTypes = [
      'image/jpeg',
      'image/png',
      'application/pdf',
      'application/msword',
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
      'application/vnd.ms-excel',
      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
      'text/plain'
    ];

    if (fileInput) {
      fileInput.addEventListener('change', () => {
        preview.innerHTML = '';
        const files = fileInput.files;

        if(files.length > maxFiles) {
          alert(`You can only upload up to ${maxFiles} files.`);
          fileInput.value = ''; // reset
          return;
        }

        for(let file of files) {
          if(!allowedTypes.includes(file.type)) {
            alert(`File type not allowed: ${file.name}`);
            fileInput.value = ''; // reset
            preview.innerHTML = '';
            return;
          }
          if(file.size > maxSizeMB * 1024 * 1024) {
            alert(`File "${file.name}" exceeds size limit of ${maxSizeMB}MB.`);
            fileInput.value = '';
            preview.innerHTML = '';
            return;
          }
          const fileElement = document.createElement('div');
          fileElement.textContent = `${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
          preview.appendChild(fileElement);
        }
      });
    }

    if (replyForm && replyBtn) {
      replyBtn.addEventListener("click", function (e) {
        e.preventDefault();

        const replyText = replyForm.querySelector('textarea[name="reply"]').value.trim();

        if (!replyText) {
          replyForm.reportValidity();
          return;
        }

        Swal.fire({
          title: "Send Reply?",
          text: "Once sent, you cannot edit or resend this reply.",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#28a745",
          cancelButtonColor: "#6c757d",
          confirmButtonText: "Yes, Send it!",
          reverseButtons: true
        }).then(result => {
          if (result.isConfirmed) {
            spinner.style.display = 'block';
            replyBtn.disabled = true;
            replyForm.submit();
          }
        });
      });
    }

    // ===== Attachment Handling =====
    const maxAttachments = 5;
    let totalForms = parseInt($("#id_attachments-TOTAL_FORMS").val());

    $("#add-attachment").on("click", function () {
      if (totalForms >= maxAttachments) return alert("Maximum attachments reached.");
      const $newForm = $(".attachment-form:first").clone();
      $newForm.find("input, select, textarea").each(function () {
        const name = $(this).attr("name").replace("-0-", `-${totalForms}-`);
        const id = "id_" + name;
        $(this).attr({ name, id }).val("");
        if ($(this).is(":checkbox, :radio")) $(this).prop("checked", false);
      });
      $newForm.find(".remove-attachment").remove();
      $newForm.append(`
        <button type="button" class="btn btn-sm btn-danger remove-attachment" 
                style="position: absolute; top: 8px; right: 8px; font-size: 0.75rem; padding: 2px 6px;">
          <i class="fas fa-times"></i>
        </button>
      `);
      $("#attachments-container").append($newForm);
      totalForms++;
      $("#id_attachments-TOTAL_FORMS").val(totalForms);
    });

    $("#attachments-container").on("click", ".remove-attachment", function () {
      $(this).closest(".attachment-form").remove();
      totalForms--;
      $("#id_attachments-TOTAL_FORMS").val(totalForms);
    });

  });
</script>


{% endblock %}
