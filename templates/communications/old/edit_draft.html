{% extends "base.html" %} {% load static %} {% load custom_filters %} {% load
widget_tweaks %} {% block content %}
<h2 style="margin-bottom: 1rem">
  <i class="fas fa-edit" style="color:blue; margin-right: 0.5rem;"></i>
  <strong style="color:blue">Edit Communication</strong>
</h2>

<style>
  #form-fields-container {
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 1rem;
    display: flex;
    flex-wrap: wrap; /* allow wrapping */
    gap: 1rem; /* spacing between fields */
    justify-content: flex-start; /* align fields left */
    align-items: flex-start; /* align items at top */
    /* Remove scroll and nowrap */
    overflow-x: visible;
    white-space: normal;
    /* New background color */
    background-color: rgb(242, 243, 245);

    /* Optional subtle shadow for nice depth */
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  }

  #form-fields-container legend {
    font-weight: 600;
    font-size: 1.1rem;
    padding: 0 0.5rem;
    flex-basis: 100%; /* make legend take full width on its own line */
    margin-bottom: 1rem; /* space below legend */
  }

  .form-group {
    display: flex;
    flex-direction: column; /* label on top of input */
    min-width: 180px; /* minimum width for each group */
    flex-grow: 1;
    margin-top: -2rem;
    /* fields can grow to fill space */
  }

  .form-label {
    margin-bottom: 0.3rem;
    font-weight: 500;
  }
</style>

<form id="target-group-form" method="get" style="margin-bottom: 1rem">
  <fieldset id="form-fields-container">
    <legend>Select Target Group</legend>

    {% if user_role != "student" and user_role != "parent" %}
    <div id="branch-field" class="form-group">
      <label for="id_branch" class="form-label">Branch:</label>
      {{ target_group_form.branch }} {% if target_group_form.branch.errors %}
      <div class="text-danger" style="color: red; margin-top: 0.25rem">
        {{ target_group_form.branch.errors }}
      </div>
      {% endif %}
    </div>
    {% else %}
    <input
      type="hidden"
      id="id_branch"
      name="branch"
      value="{{ user_branch_id }}"
    />
    {% endif %}

    <div
      id="role-field"
      class="form-group"
      style="{% if target_group_form.role.errors %}display: block{% else %}display: none{% endif %}"
    >
      <label for="id_role" class="form-label">Role:</label>
      {{ target_group_form.role }} {% if target_group_form.role.errors %}
      <div class="text-danger" style="color: red; margin-top: 0.25rem">
        {{ target_group_form.role.errors }}
      </div>
      {% endif %}
    </div>

    <div id="staff-type-field" class="form-group" style="display: none">
      <label for="id_staff_type" class="form-label">Staff Type:</label>
      {{ target_group_form.staff_type }} 
      {% if target_group_form.staff_type.errors %}
      <div class="text-danger" style="color: red; margin-top: 0.25rem">
        {{ target_group_form.staff_type.errors }}
      </div>
      {% endif %}
    </div>

    <div id="teaching-positions-field" class="form-group" style="display: none">
      <label for="id_teaching_positions" class="form-label"
        >Teaching Positions:</label
      >
      {{ target_group_form.teaching_positions }} 
      {% if target_group_form.teaching_positions.errors %}
      <div class="text-danger" style="color: red; margin-top: 0.25rem">
        {{ target_group_form.teaching_positions.errors }}
      </div>
      {% endif %}
    </div>

    <div
      id="non-teaching-positions-field"
      class="form-group"
      style="display: none"
    >
      <label for="id_non_teaching_positions" class="form-label"
        >Non-Teaching Positions:</label
      >
      {{ target_group_form.non_teaching_positions }} 
      {% if target_group_form.non_teaching_positions.errors %}
      <div class="text-danger" style="color: red; margin-top: 0.25rem">
        {{ target_group_form.non_teaching_positions.errors }}
      </div>
      {% endif %}
    </div>

    <div id="student-class-field" class="form-group" style="display: none">
      <label for="id_student_class" class="form-label">Student Class:</label>
      {{ target_group_form.student_class }} 
      {% if target_group_form.student_class.errors %}
      <div class="text-danger" style="color: red; margin-top: 0.25rem">
        {{ target_group_form.student_class.errors }}
      </div>
      {% endif %}
    </div>

    <div id="class-arm-field" class="form-group" style="display: none">
      <label for="id_class_arm" class="form-label">Class Arm:</label>
      {{ target_group_form.class_arm }} 
      {% if target_group_form.class_arm.errors %}
      <div class="text-danger" style="color: red; margin-top: 0.25rem">
        {{ target_group_form.class_arm.errors }}
      </div>
      {% endif %}
    </div>
  </fieldset>
</form>
<script>
  const savedSelectedRecipients = {{ saved_selected_recipients_json|safe }};
</script>

{% if communication_form.non_field_errors %}
<div
  style="
    color: red;
    background-color: white;
    border: 1px solid red;
    padding: 0.75rem;
    margin-bottom: 1rem;
  "
>
  {% for error in communication_form.non_field_errors %}
  <div>{{ error }}</div>
  {% endfor %}
</div>
{% endif %}

<h3 style="margin-bottom: 1rem">Filtered Recipients</h3>
<table
  id="recipients-table"
  class="table table-striped"
  style="width: 100%; border-collapse: collapse; margin-bottom: 2rem"
>
  <thead style="background-color: #007bff; color: white">
    <tr>
      <th style="padding: 0.5rem; text-align: center">
        <input type="checkbox" id="select-all-recipients" />
      </th>
      <th style="padding: 0.5rem; text-align: center">S/N</th>
      <th style="padding: 0.5rem; text-align: center">Profile Picture</th>
      <th style="padding: 0.5rem; text-align: center">Branch</th>
      <th style="padding: 0.5rem; text-align: left">Name</th>
      <th style="padding: 0.5rem; text-align: left">Email</th>
    </tr>
  </thead>
  <tbody style="border: 1px solid #ddd">
    <tr>
      <td></td>
      <td></td>
      <td
        colspan="6"
        style="
          padding: 1rem;
          text-align: center;
          font-style: italic;
          color: #555;
        "
      >
        Select filters above to view recipients.
      </td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
  </tbody>
</table>

<form
  id="communication-form"
  method="post"
  action="{% url 'edit_draft_message' communication.pk %}"
  enctype="multipart/form-data"
  style="max-width: 100%"
  data-user-role="{{ request.user.role }}"
>
  {% csrf_token %}
  

  {% if attachment_formset.non_form_errors %}
  <div class="alert alert-danger" style="margin-bottom: 1rem">
    {{ attachment_formset.non_form_errors }}
  </div>
  {% endif %}

  <div
    style="
      display: flex;
      gap: 2rem;
      align-items: flex-start;
      flex-wrap: wrap;
      background-color: rgb(242, 243, 245);
    "
  >
    <div style="display: flex; flex-wrap: wrap; gap: 1rem; width: 100%">
      <!-- Left Column: Message Details -->
      <fieldset
        style="
          flex: 1;
          border: 1px solid #ccc;
          border-radius: 8px;
          padding: 1rem;
          min-width: 300px;
        "
      >
        <legend style="font-weight: 600; font-size: 1.2rem; padding: 0 0.5rem">
          Message Details
        </legend>

        {% for field in communication_form %} 
        {% if field.name != 'is_draft' and field.name != 'requires_response' %}
        <div class="form-group mb-3 d-flex flex-column">
          <label
            for="{{ field.id_for_label }}"
            class="form-label fw-semibold mb-1"
          >
            {{ field.label }}:
          </label>
          {{ field }} {% if field.help_text %}
          <small class="form-text text-muted">{{ field.help_text }}</small>
          {% endif %} {% if field.errors %}
          <div class="text-danger mt-1">{{ field.errors }}</div>
          {% endif %}
        </div>
        {% endif %} {% endfor %}

        <div
          class="form-switch-group p-4 mt-4 rounded-4"
          style="background-color: #ddd"
        >
          <h6 class="text-black mb-3 fw-semibold">Additional Options</h6>
          <div class="d-flex flex-column flex-md-row gap-4">
            {% for field in communication_form %} 
            {% if field.name == 'is_draft' or field.name == 'requires_response' %}
            <div class="form-check form-switch text-white">
              {{ field }}
              <label
                class="form-check-label fw-semibold ms-2"
                for="{{ field.id_for_label }}"
              >
                {{ field.label }}
              </label>
              {% if field.help_text %}
              <div class="form-text text-light small">
                {{ field.help_text }}
              </div>
              {% endif %} {% if field.errors %}
              <div class="text-danger small">{{ field.errors }}</div>
              {% endif %}
            </div>
            {% endif %} {% endfor %}
          </div>
        </div>
      </fieldset>

      <!-- Right Column: Attachments -->
      <fieldset>
        <h6 style="color: black; font-weight: 600; margin-bottom: 0.75rem">
          <i class="fas fa-paperclip me-2" style="color: green"></i
          ><strong>Attachments</strong>
        </h6>
        {% if attachment_formset.non_form_errors %}
        <div class="alert alert-danger">
          {% for error in attachment_formset.non_form_errors %}
          <div>{{ error }}</div>
          {% endfor %}
        </div>
        {% endif %}

        <!-- Management form -->
        {{ attachment_formset.management_form }}

        <!-- Existing forms -->
        <div id="attachments-container">
          {% for form in attachment_formset.forms %}
          <div class="attachment-form mb-2 position-relative">
            {{ form.file.label_tag }} {{ form.file }} {% if form.DELETE %}{{
            form.DELETE }}{% endif %}
            <button
              type="button"
              class="btn btn-sm btn-danger remove-attachment mt-1"
              style="position: absolute; top: 8px; right: 8px"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
          {% endfor %}
        </div>

        <!-- Hidden template -->
        <div id="empty-form-template" style="display: none">
          <div class="attachment-form mb-2 position-relative">
            {{ attachment_formset.empty_form.file.label_tag }} {{
            attachment_formset.empty_form.file }}
            <button
              type="button"
              class="btn btn-sm btn-danger remove-attachment mt-1"
              style="position: absolute; top: 8px; right: 8px"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <!-- Add More Button -->
        <button
          type="button"
          id="add-attachment"
          class="btn btn-sm btn-outline-success mt-2"
        >
          + Add More Files
        </button>
      </fieldset>

      <!-- Spinner (optional) -->
      <div id="upload-spinner" style="display: none; margin-top: 10px">
        <img
          src="{% static 'assets/img/spinner.gif' %}"
          alt="Uploading..."
          width="40"
        />
        Uploading files, please wait...
      </div>
    </div>
  </div>

  <input type="hidden" name="selected_recipients" id="selected-recipients" />

    <button type="submit" name="action" value="draft" id="save-draft-btn" class="btn btn-primary" title="Save without sending">
      Save as Draft
    </button>
    <button type="submit" name="action" value="send" id="send-message-btn" class="btn btn-success" title="Send message to recipients">
      Send Message
    </button>

</form>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- SweetAlert2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  const savedFilterData = {{ saved_filter_data|safe }};
  const savedSelectedRecipients = {{ selected_recipient_ids|safe }};
  const isEditingDraft = {{ editing_draft|yesno:"true,false" }};
</script>

<script>
  let recipientsTable;

  $(document).ready(function () {
    const $form = $("#target-group-form");
    const $recipientsTableBody = $("#recipients-table tbody");
    const $selectAll = $("#select-all-recipients");
    const $communicationForm = $("#communication-form");
    const userRole = $communicationForm.data("user-role");
    const $communicationForm = $("#communication-form");
    const $draftCheckbox = $("#id_is_draft");
    const $saveDraftButton = $("#save-draft");

    const fields = {
      branch: $("#id_branch"),
      role: $("#id_role"),
      staffType: $("#id_staff_type"),
      teaching: $("#id_teaching_positions"),
      nonTeaching: $("#id_non_teaching_positions"),
      studentClass: $("#id_student_class"),
      classArm: $("#id_class_arm"),
    };

    let selectedRecipients = new Set();

    function preloadFromServer() {
      if (typeof isEditingDraft !== "undefined" && isEditingDraft) {
        if (typeof savedFilterData === "object") {
          for (const id in savedFilterData) {
            const $el = $("#" + id);
            if ($el.length) {
              if ($el.is(":checkbox")) {
                $el.prop("checked", savedFilterData[id]);
              } else {
                $el.val(savedFilterData[id]);
              }
            }
          }
        }

        if (Array.isArray(savedSelectedRecipients)) {
          selectedRecipients = new Set(savedSelectedRecipients.map(String));
        }

        updateBranchVisibility();
        updateRoleVisibility();
        updateStaffTypeVisibility();
        updateStudentClassVisibility();
      } else {
        loadFilters();
        loadSelectedRecipients();
      }
    }


    function loadFilters() {
      const saved = localStorage.getItem("targetGroupFilters");
      if (!saved) return;
      const filters = JSON.parse(saved);
      for (const id in filters) {
        const $el = $("#" + id);
        if ($el.length) {
          if ($el.is(":checkbox")) {
            $el.prop("checked", filters[id]);
          } else {
            $el.val(filters[id]);
          }
        }
      }
    }

    // ===== Initialize DataTable =====
    if (!$.fn.DataTable.isDataTable("#recipients-table")) {
      recipientsTable = $("#recipients-table").DataTable({
        columnDefs: [{ targets: 0, orderable: false, searchable: false }],
        order: [[1, "asc"]],
      });
    } else {
      recipientsTable = $("#recipients-table").DataTable();
    }

    // ===== Utility Functions =====
    function areFiltersEmpty() {
      for (const key in fields) {
        const field = fields[key];
        if ((userRole === "student" || userRole === "parent") && key !== "role") continue;
        if ((userRole !== "student" && userRole !== "parent") && key === "role") continue;
        if (field.is(":checkbox")) {
          if (field.prop("checked")) return false;
        } else {
          const val = field.val();
          if (val && val.toString().trim() !== "" && val !== "------------") return false;
        }
      }
      return true;
    }

    function saveFilters() {
      const filters = {};
      $form.find("select, input[type=checkbox]").each(function () {
        const $el = $(this);
        filters[$el.attr("id")] = $el.is(":checkbox") ? $el.prop("checked") : $el.val();
      });
      localStorage.setItem("targetGroupFilters", JSON.stringify(filters));
    }

    function clearFiltersStorage() {
      localStorage.removeItem("targetGroupFilters");
    }

    function clearSelectedRecipients() {
      selectedRecipients.clear();
      localStorage.removeItem("selectedRecipients");
    }

    function resetFields(keys) {
      keys.forEach((key) => {
        const field = fields[key];
        if (field.is("select")) {
          field.val("");
        } else {
          field.find("input[type=checkbox]").prop("checked", false);
        }
      });
    }

    function updateBranchVisibility() {
      if (fields.branch.val()) {
        $("#role-field").show();
      } else {
        $("#role-field, #staff-type-field, #teaching-positions-field, #non-teaching-positions-field, #student-class-field, #class-arm-field").hide();
        resetFields(["role", "staffType", "teaching", "nonTeaching", "studentClass", "classArm"]);
      }
    }

    function updateRoleVisibility() {
      const role = fields.role.val();
      if (role === "staff") {
        $("#staff-type-field").show();
        $("#student-class-field, #class-arm-field").hide();
        resetFields(["studentClass", "classArm"]);
        updateStaffTypeVisibility();
      } else if (role === "student") {
        $("#staff-type-field, #teaching-positions-field, #non-teaching-positions-field").hide();
        resetFields(["staffType", "teaching", "nonTeaching"]);
        $("#student-class-field").show();
        updateStudentClassVisibility();
      } else {
        $("#staff-type-field, #teaching-positions-field, #non-teaching-positions-field, #student-class-field, #class-arm-field").hide();
        resetFields(["staffType", "teaching", "nonTeaching", "studentClass", "classArm"]);
      }
    }

    function updateStaffTypeVisibility() {
      const type = fields.staffType.val();
      const $teaching = $("#teaching-positions-field");
      const $nonTeaching = $("#non-teaching-positions-field");

      if (type === "teaching") {
        $teaching.show();
        $nonTeaching.hide().find("input[type=checkbox]").prop("checked", false);
      } else if (type === "non_teaching") {
        $nonTeaching.show();
        $teaching.hide().find("input[type=checkbox]").prop("checked", false);
      } else if (type === "both") {
        $teaching.show();
        $nonTeaching.show();
      } else {
        $teaching.hide().find("input[type=checkbox]").prop("checked", false);
        $nonTeaching.hide().find("input[type=checkbox]").prop("checked", false);
      }
    }

    function updateStudentClassVisibility() {
      const show = !!fields.studentClass.val();
      $("#class-arm-field").toggle(show);
      if (!show) fields.classArm.val("");
    }

    function saveSelectedRecipients() {
      localStorage.setItem("selectedRecipients", JSON.stringify([...selectedRecipients]));
    }

    function loadSelectedRecipients() {
      selectedRecipients = new Set(JSON.parse(localStorage.getItem("selectedRecipients") || "[]"));
    }

    function updateRecipientTableCheckboxStates() {
      $(".recipient-checkbox").each(function () {
        const id = $(this).val();
        $(this).prop("checked", selectedRecipients.has(id));
      });
      $selectAll.prop(
        "checked",
        $(".recipient-checkbox:checked").length === $(".recipient-checkbox").length
      );
    }

    function loadRecipients() {
      if (areFiltersEmpty()) {
        recipientsTable.clear().draw();
        $selectAll.prop("checked", false);
        $recipientsTableBody.html('<tr><td colspan="6" class="text-center p-4">No users found.</td></tr>');
        return;
      }

      if (userRole === "student") {
        if (fields.role.val() === "student") {
          const studentClass = fields.studentClass.val();
          const classArm = fields.classArm.val();
          if (!studentClass || !classArm) {
            recipientsTable.clear().draw();
            $selectAll.prop("checked", false);
            $recipientsTableBody.html('<tr><td colspan="6" class="text-center p-4">Please select class and arm to view students.</td></tr>');
            return;
          }
        }
      }

      const queryData = $form.serializeArray().filter(item => {
        const val = item.value && item.value.trim();
        if (!val) return false;

        const role = fields.role.val();
        const staffType = fields.staffType.val();

        if (role !== "student" && (item.name === "student_class" || item.name === "class_arm")) return false;
        if (role !== "staff" && item.name === "staff_type") return false;

        if (role === "staff") {
          const hasTeaching = fields.teaching.find("input:checked").length > 0;
          const hasNonTeaching = fields.nonTeaching.find("input:checked").length > 0;

          if (staffType === "both" && !hasTeaching && !hasNonTeaching) {
            recipientsTable.clear().draw();
            $recipientsTableBody.html('<tr><td colspan="6" class="text-center p-4">Please select at least one Teaching or Non-Teaching position.</td></tr>');
            return false;
          }

          if (staffType === "non_teaching" && !hasNonTeaching) {
            recipientsTable.clear().draw();
            $recipientsTableBody.html('<tr><td colspan="6" class="text-center p-4">Please select at least one Non-Teaching position.</td></tr>');
            return false;
          }

          if (staffType === "teaching" && !hasTeaching) {
            recipientsTable.clear().draw();
            $recipientsTableBody.html('<tr><td colspan="6" class="text-center p-4">Please select at least one Teaching position.</td></tr>');
            return false;
          }
        }

        return true;
      });

      if (queryData.length === 0) {
        recipientsTable.clear().draw();
        $recipientsTableBody.html('<tr><td colspan="6" class="text-center p-4">Please apply valid filters to see results.</td></tr>');
        return;
      }

      let savedSelectedRecipients = JSON.parse(localStorage.getItem("selectedRecipients") || "[]");

      $.get("{% url 'get_filtered_users' %}", $.param(queryData), function (response) {
        recipientsTable.clear();
        $recipientsTableBody.empty();  // Clear any existing rows manually if needed

        const returnedIds = new Set(response.map(user => String(user.id)));

        if (response.length === 0 && selectedRecipients.size === 0) {
          recipientsTable.draw();
          $selectAll.prop("checked", false);
          $recipientsTableBody.html('<tr><td colspan="6" class="text-center p-4">No users found.</td></tr>');
          return;
        }

        // Add users returned by current filter
        response.forEach((user, index) => {
          const profilePic = (user.profile_picture && user.profile_picture.url) || "/static/assets/img/profile-pic.png";
          const isChecked = selectedRecipients.has(String(user.id));

          recipientsTable.row.add([
            `<input type="checkbox" class="recipient-checkbox" value="${user.id}" ${isChecked ? "checked" : ""}>`,
            index + 1,
            `<img src="${profilePic}" alt="Profile Picture" width="30" height="30" style="border-radius: 50%; object-fit: cover;">`,
            user.branch__name,
            `${user.first_name} ${user.last_name}`,
            user.email,
          ]);
        });

        // Handle selected recipients not in current filter response
        if (isEditingDraft) {
          const saved = Array.from(selectedRecipients).map(String);
          const missing = saved.filter(id => !returnedIds.has(id));

          let pending = missing.length;
          if (pending === 0) {
            recipientsTable.draw();
            updateRecipientTableCheckboxStates();
            return;
          }

          missing.forEach((id) => {
            $.get("{% url 'get_user_by_id' %}", { id: id }, function (user) {
              if (user && user.id) {
                const profilePic = (user.profile_picture && user.profile_picture.url) || "/static/assets/img/profile-pic.png";
                recipientsTable.row.add([
                  `<input type="checkbox" class="recipient-checkbox" value="${user.id}" checked>`,
                  recipientsTable.rows().count() + 1,
                  `<img src="${profilePic}" alt="Profile Picture" width="30" height="30" style="border-radius: 50%; object-fit: cover;">`,
                  user.branch__name,
                  `${user.first_name} ${user.last_name}`,
                  user.email,
                ]);
              }
            }).always(() => {
              pending -= 1;
              if (pending === 0) {
                recipientsTable.draw();
                updateRecipientTableCheckboxStates();
              }
            });
          });
        } else {
          recipientsTable.draw();
          updateRecipientTableCheckboxStates();
        }

      });

    }

    function handleDependencyChange() {
      clearSelectedRecipients();
      $selectAll.prop("checked", false);
      saveFilters();
      loadRecipients();
    }

    // ===== Events =====
    fields.branch.on("change", () => {
      updateBranchVisibility(); updateRoleVisibility(); handleDependencyChange();
    });

    fields.role.on("change", () => {
      updateRoleVisibility(); handleDependencyChange();
    });

    fields.staffType.on("change", () => {
      updateStaffTypeVisibility(); handleDependencyChange();
    });

    fields.studentClass.on("change", () => {
      updateStudentClassVisibility(); handleDependencyChange();
    });

    $form.find("select, input[type=checkbox]").not("#select-all-recipients").on("change", handleDependencyChange);

    $recipientsTableBody.on("change", ".recipient-checkbox", function () {
      const id = $(this).val();
      $(this).is(":checked") ? selectedRecipients.add(id) : selectedRecipients.delete(id);
      saveSelectedRecipients();
      updateRecipientTableCheckboxStates();
    });

    $selectAll.on("change", function () {
      const checked = this.checked;
      $(".recipient-checkbox").each(function () {
        $(this).prop("checked", checked);
        const id = $(this).val();
        checked ? selectedRecipients.add(id) : selectedRecipients.delete(id);
      });
      saveSelectedRecipients();
    });

    // Save as Draft validation with SweetAlert
    $("#save-draft-btn").on("click", function (e) {
      if (!isDraftModeEnabled()) {
        e.preventDefault();
        Swal.fire({
          title: "Draft Not Checked",
          text: "Please check 'Save as Draft' before saving.",
          icon: "warning",
          confirmButtonColor: "#3085d6",
          confirmButtonText: "OK"
        });
        return false;
      }

      saveFilters();
      saveSelectedRecipients();
    });


    // Clear local storage if final send
    if (isSendAction && typeof clearFiltersStorage === "function") {
      clearFiltersStorage();
      localStorage.removeItem("selectedRecipients");
    }

    // Submit validation with SweetAlert

    function isDraftModeEnabled() {
      return $draftCheckbox.is(":checked");
    }

    // Handle Save as Draft button
    $saveDraftButton.on("click", function (e) {
      if (!isDraftModeEnabled()) {
        e.preventDefault();
        Swal.fire({
          title: "Draft Not Checked",
          text: "Please check 'Save as Draft' before saving.",
          icon: "warning",
          confirmButtonColor: "#3085d6",
          confirmButtonText: "OK"
        });
        return false;
      }

      // Save localStorage data before saving draft
      saveFilters();
      saveSelectedRecipients();
    });

    // Handle full form submission (either send or save as draft)
    $communicationForm.on("submit", function (e) {
      const submitButton = document.activeElement;

      // Prevent sending message while 'Save as Draft' is checked
      if ($(submitButton).val() === "send" && isDraftModeEnabled()) {
        e.preventDefault();
        Swal.fire({
          title: "Draft is Checked",
          text: "You cannot send a message while 'Save as Draft' is checked. Please uncheck it to proceed.",
          icon: "error",
          confirmButtonColor: "#3085d6",
          confirmButtonText: "OK"
        });
        return false;
      }

      // Branch and Role validations
      if (["staff", "branch_admin", "superadmin"].includes(userRole) && !$("#id_branch").val()) {
        e.preventDefault();
        Swal.fire({
          title: "Missing Branch",
          text: "Please select a Branch before submitting the form.",
          icon: "warning",
          confirmButtonColor: "#3085d6",
          confirmButtonText: "OK"
        });
        return false;
      }

      if (["student", "parent"].includes(userRole) && !$("#id_role").val()) {
        e.preventDefault();
        Swal.fire({
          title: "Missing Role",
          text: "Please select a Role before submitting the form.",
          icon: "warning",
          confirmButtonColor: "#3085d6",
          confirmButtonText: "OK"
        });
        return false;
      }

      // Inject selected filters into form before submitting
      const filterFieldNames = [
        "branch", "role", "staff_type",
        "teaching_positions", "non_teaching_positions",
        "student_class", "class_arm"
      ];

      filterFieldNames.forEach(function (name) {
        const $fields = $("#target-group-form [name='" + name + "']");
        if ($fields.length && $fields[0].type === "checkbox") {
          $fields.filter(":checked").each(function () {
            $("<input>", {
              type: "hidden",
              name,
              value: $(this).val(),
              class: "injected-filter-field"
            }).appendTo($communicationForm);
          });
        } else {
          const val = $fields.val();
          if (Array.isArray(val)) {
            val.forEach(function (item) {
              $("<input>", {
                type: "hidden",
                name,
                value: item,
                class: "injected-filter-field"
              }).appendTo($communicationForm);
            });
          } else if (val !== undefined && val !== null && val !== "") {
            $("<input>", {
              type: "hidden",
              name,
              value: val,
              class: "injected-filter-field"
            }).appendTo($communicationForm);
          }
        }
      });

      // Inject selected recipients
      $communicationForm.find('input[name="selected_recipients"]').remove();
      [...selectedRecipients].forEach(function (id) {
        $("<input>", {
          type: "hidden",
          name: "selected_recipients",
          value: id
        }).appendTo($communicationForm);
      });

      // Clear storage if sending
      if ($(submitButton).val() === "send") {
        clearFiltersStorage();
        localStorage.removeItem("selectedRecipients");
      }

      $communicationForm.off("submit").submit();
    });
  
    // ===== Attachment Handling =====
    const maxAttachments = 5;

    function getActiveAttachmentCount() {
      return $("#attachments-container .attachment-form").filter(function () {
        return !$(this).find("input[type='checkbox'][name$='-DELETE']").is(":checked");
      }).length;
    }

    $("#add-attachment").on("click", function () {
      const totalForms = parseInt($("#id_attachments-TOTAL_FORMS").val());
      const activeCount = getActiveAttachmentCount();

      if (activeCount >= maxAttachments) {
        alert("Maximum attachments reached.");
        return;
      }

      // Clone the empty form template
      const $template = $("#empty-form-template .attachment-form").clone();
      const formRegex = /__prefix__/g;

      // Update all input names and IDs
      $template.find("input, select, textarea, label").each(function () {
        if ($(this).attr("name")) {
          $(this).attr("name", $(this).attr("name").replace(formRegex, totalForms));
        }
        if ($(this).attr("id")) {
          $(this).attr("id", $(this).attr("id").replace(formRegex, totalForms));
        }
        if ($(this).is("input[type='file']")) {
          $(this).val("");  // Clear file input
        }
      });

      // Append to the form container
      $("#attachments-container").append($template);

      // Increment the form count
      $("#id_attachments-TOTAL_FORMS").val(totalForms + 1);
    });

    // Remove button logic
    $("#attachments-container").on("click", ".remove-attachment", function () {
      const $form = $(this).closest(".attachment-form");
      const $deleteInput = $form.find("input[type='checkbox'][name$='-DELETE']");

      if ($deleteInput.length) {
        $deleteInput.prop("checked", true);
        $form.hide();
      } else {
        $form.remove();
        const updatedCount = $("#attachments-container .attachment-form").length;
        $("#id_attachments-TOTAL_FORMS").val(updatedCount);
      }
    });

    // ===== Initial Setup =====
    preloadFromServer(); // Handles filters + visibility

    loadRecipients();
    updateRecipientTableCheckboxStates(); // Reflect selected recipients
    });
  });
</script>

<script>
  $("form").on("submit", function () {
    $("#upload-spinner").show(); // Show the spinner
    $(this).find("button[type='submit']").prop("disabled", true); // Disable submit buttons
  });
</script> 

{% endblock %}
