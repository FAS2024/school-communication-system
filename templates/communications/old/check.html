{% extends "base.html" %}
{% load static %}

{% block content %}
<h2 style="margin-bottom: 1rem;">Create Communication</h2>

<form id="target-group-form" method="get" style="margin-bottom: 2rem;">
  <fieldset style="border: 1px solid #ccc; border-radius: 8px; padding: 1rem;">
    <legend style="padding: 0 0.5rem; font-weight: 600; font-size: 1.1rem;">Select Target Group</legend>

    {% if user_role != "student" and user_role != "parent" %}
      <div id="branch-field" class="form-group">
        <label for="id_branch" class="form-label">Branch:</label>
        {{ target_group_form.branch }}
      </div>
    {% else %}
      <input type="hidden" id="id_branch" name="branch" value="{{ user_branch_id }}">
    {% endif %}

    <div id="role-field" class="form-group" style="display: none;">
      <label for="id_role" class="form-label">Role:</label>
      {{ target_group_form.role }}
    </div>

    <div id="staff-type-field" class="form-group" style="display: none;">
      <label for="id_staff_type" class="form-label">Staff Type:</label>
      {{ target_group_form.staff_type }}
    </div>

    <div id="teaching-positions-field" class="form-group" style="display: none;">
      <label for="id_teaching_positions" class="form-label">Teaching Positions:</label>
      {{ target_group_form.teaching_positions }}
    </div>

    <div id="non-teaching-positions-field" class="form-group" style="display: none;">
      <label for="id_non_teaching_positions" class="form-label">Non-Teaching Positions:</label>
      {{ target_group_form.non_teaching_positions }}
    </div>

    <div id="student-class-field" class="form-group" style="display: none;">
      <label for="id_student_class" class="form-label">Student Class:</label>
      {{ target_group_form.student_class }}
    </div>

    <div id="class-arm-field" class="form-group" style="display: none;">
      <label for="id_class_arm" class="form-label">Class Arm:</label>
      {{ target_group_form.class_arm }}
    </div>
  </fieldset>
</form>

<h3 style="margin-bottom: 1rem;">Filtered Recipients</h3>
<table id="recipients-table" class="table table-striped" style="width: 100%; border-collapse: collapse; margin-bottom: 2rem;">
  <thead style="background-color: #007bff; color: white;">
    <tr>
      <th style="padding: 0.5rem; text-align: center;">
        <input type="checkbox" id="select-all-recipients" />
      </th>
      <th style="padding: 0.5rem; text-align: center;">S/N</th>
      <th style="padding: 0.5rem; text-align: center;">Profile Picture</th>
      <th style="padding: 0.5rem; text-align: center;">Branch</th>
      <th style="padding: 0.5rem; text-align: left;">Name</th>
      <th style="padding: 0.5rem; text-align: left;">Email</th>
    </tr>
  </thead>
  <tbody style="border: 1px solid #ddd;">
    <tr>
      <td colspan="6" style="padding: 1rem; text-align: center; font-style: italic; color: #555;">
        Select filters above to view recipients.
      </td>
    </tr>
  </tbody>
</table>

<form id="communication-form" method="post" enctype="multipart/form-data" style="max-width: 900px;">
  {% csrf_token %}
  <div style="display: flex; gap: 2rem; align-items: flex-start; flex-wrap: wrap;">

    <!-- Left Column: Message Details -->
    <fieldset style="flex: 1 1 300px; border: 1px solid #ccc; border-radius: 8px; padding: 1rem;">
      <legend style="font-weight: 600; font-size: 1.2rem; padding: 0 0.5rem;">Message Details</legend>

      {% for field in communication_form %}
        <div class="form-group" style="margin-bottom: 1rem; display: flex; flex-direction: column;">
          <label for="{{ field.id_for_label }}" class="form-label" style="font-weight: 600; margin-bottom: 0.25rem;">{{ field.label }}:</label>
          {{ field }}
          {% if field.help_text %}
            <small class="form-text text-muted" style="margin-top: 0.25rem;">{{ field.help_text }}</small>
          {% endif %}
          {% if field.errors %}
            <div class="text-danger" style="margin-top: 0.25rem;">{{ field.errors }}</div>
          {% endif %}
        </div>
      {% endfor %}
    </fieldset>

    <!-- Right Column: Attachments -->
    <fieldset style="flex: 1 1 300px; border: 1px solid #ccc; border-radius: 8px; padding: 1rem;">
      <legend style="font-weight: 600; font-size: 1.2rem; padding: 0 0.5rem;">Attachments</legend>
      {{ attachment_formset.management_form }}
      <div id="attachments-container">
        {% for form in attachment_formset.forms %}
          <div class="attachment-form {% if forloop.counter > 2 %}extra-attachment{% endif %}" style="margin-bottom: 1rem; position: relative;">
            {{ form.as_p }}
            {% if forloop.counter > 2 %}
              <button type="button" class="btn btn-danger remove-attachment" style="position: absolute; top: 10px; right: 10px;">Remove</button>
            {% endif %}
          </div>
        {% endfor %}
      </div>
      <button type="button" id="add-attachment" class="btn btn-success" style="margin-top: 0.75rem;">Add More Files</button>
    </fieldset>

  </div>

  <input type="hidden" name="selected_recipients" id="selected-recipients" />
  <button type="submit" class="btn btn-primary" style="margin-top: 2rem; padding: 0.75rem 2rem; font-size: 1rem;">Send Message</button>
</form>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
  $(document).ready(function () {
    const $form = $("#target-group-form");
    const $recipientsTableBody = $("#recipients-table tbody");
    const $selectAll = $("#select-all-recipients");

    function loadRecipients() {
      const data = $form.serialize();
      $.get("{% url 'get_filtered_users' %}", data, function (response) {
        $recipientsTableBody.empty();

        if (response.length === 0) {
          $recipientsTableBody.append('<tr><td colspan="6" style="text-align:center; padding: 1rem;">No users found.</td></tr>');
          return;
        }

        let index = 1;
        for (const user of response) {
          const row = `
            <tr style="border-bottom: 1px solid #eee;">
              <td style="text-align:center;">
                <input type="checkbox" class="recipient-checkbox" value="${user.id}">
              </td>
              <td style="text-align:center;">${index}</td>
              <td style="text-align:center;">
                <img src="${user.profile_picture ? user.profile_picture : '/static/assets/img/profile-pic.png'}"
                     alt="Profile Picture" width="30" height="30"
                     style="border-radius: 50%; object-fit: cover;">
              </td>
              <td style="text-align:center;">${user.branch__name}</td>
              <td>${user.first_name} ${user.last_name}</td>
              <td>${user.email}</td>
            </tr>`;
          $recipientsTableBody.append(row);
          index++;
        }

        $selectAll.prop("checked", false);
      });
    }

    $form.find("select, input[type=checkbox]").on("change", loadRecipients);

    $selectAll.on("change", function () {
      $(".recipient-checkbox").prop("checked", this.checked);
    });

    $("#communication-form").on("submit", function () {
      $('#communication-form input[name="selected_recipients"]').remove();
      $(".recipient-checkbox:checked").each(function () {
        $("<input>")
          .attr({ type: "hidden", name: "selected_recipients", value: this.value })
          .appendTo("#communication-form");
      });
    });

    const roleField = $("#id_role");
    const staffTypeField = $("#id_staff_type");
    const teachingField = $("#id_teaching_positions");
    const nonTeachingField = $("#id_non_teaching_positions");
    const studentClassField = $("#id_student_class");
    const classArmField = $("#id_class_arm");

    {% if user_role == "student" or user_role == "parent" %}
      $("#role-field").show();
    {% else %}
      $("#id_branch").on("change", function () {
        if ($(this).val()) {
          $("#role-field").show();
        } else {
          $("#role-field, #staff-type-field, #teaching-positions-field, #non-teaching-positions-field, #student-class-field, #class-arm-field").hide();
        }
      });
    {% endif %}

    roleField.on("change", function () {
      const selectedRole = $(this).val();
      if (selectedRole === "staff") {
        $("#staff-type-field").show();
        $("#student-class-field, #class-arm-field").hide();
      } else if (selectedRole === "student") {
        $("#staff-type-field, #teaching-positions-field, #non-teaching-positions-field").hide();
        $("#student-class-field").show();
      } else {
        $("#staff-type-field, #teaching-positions-field, #non-teaching-positions-field, #student-class-field, #class-arm-field").hide();
      }
    });

    staffTypeField.on("change", function () {
      const staffType = $(this).val();
      if (staffType === "teaching") {
        $("#teaching-positions-field").show();
        $("#non-teaching-positions-field").hide();
      } else if (staffType === "non-teaching") {
        $("#non-teaching-positions-field").show();
        $("#teaching-positions-field").hide();
      } else {
        $("#teaching-positions-field, #non-teaching-positions-field").hide();
      }
    });

    studentClassField.on("change", function () {
      if ($(this).val()) {
        $("#class-arm-field").show();
      } else {
        $("#class-arm-field").hide();
      }
    });

    // Attachment Add/Remove
    $("#add-attachment").on("click", function () {
      const totalForms = $("#id_form-TOTAL_FORMS");
      let formCount = parseInt(totalForms.val());
      if (formCount >= 10) {
        alert("Maximum 10 attachments allowed.");
        return;
      }

      const newForm = $(".attachment-form:first").clone(false);
      newForm.find("input, select, textarea").each(function () {
        const name = $(this).attr("name").replace("0", formCount);
        const id = "id_" + name;
        $(this).attr({ name: name, id: id }).val("");
      });
      newForm.find(".text-danger").remove();
      newForm.append('<button type="button" class="btn btn-danger remove-attachment" style="position: absolute; top: 10px; right: 10px;">Remove</button>');
      $("#attachments-container").append(newForm);
      totalForms.val(formCount + 1);
    });

    $("#attachments-container").on("click", ".remove-attachment", function () {
      $(this).closest(".attachment-form").remove();
      const totalForms = $("#id_form-TOTAL_FORMS");
      let formCount = parseInt(totalForms.val());
      totalForms.val(formCount - 1);
    });

  });
</script>

<style>
  .form-group {
    margin-bottom: 1rem;
  }

  .form-label {
    font-weight: 600;
  }

  .table-striped tbody tr:nth-child(odd) {
    background-color: #f9f9f9;
  }

  .table-striped tbody tr:hover {
    background-color: #e6f0ff;
  }

  input[type="checkbox"] {
    cursor: pointer;
  }

  button.btn {
    cursor: pointer;
  }

  #attachments-container .attachment-form {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 1rem;
    position: relative;
    background-color: #fafafa;
  }
</style>
{% endblock %}
